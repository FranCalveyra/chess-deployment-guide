# Chess Framework Deployment Guide

This guide provides a step-by-step process for deploying the Chess project from [Design System](https://github.com/austral-ingsis-classroom/chess-template). Follow the instructions below to set up and deploy the project.

## Prerequisites

Before you begin, ensure you have the following installed:
- [Docker](https://www.docker.com)
- [Git](https://git-scm.com)

## Step 1: Clone the Repository

First, clone the repository from GitHub to your local machine.

```bash
git clone ${CHESS_REPOSITORY_URL}
cd chess
```

## Step 2: Build the Project

Use Gradle to build the project. This will compile the source code and package it into a JAR file.\
You _will_ need to change the `build.gradle` in the `engine` folder

### build.gradle
```groovy
plugins {
    id 'application-conventions'
    id 'org.openjfx.javafxplugin' version '0.0.13'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
    id 'jpro-gradle-plugin'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.apache.commons:commons-text'
}

javafx {
    // Define the JavaFX version to use.
    version = "21"
    modules = ['javafx.graphics']
}

application {
    // Define the main class for the application.
    mainClass = 'Application name (must include whole package source)'
    //Example: edu.austral.dissis.chess.ui.ChessGameApplication
}

jar {
    manifest {
        attributes 'Main-Class': application.mainClass
        attributes 'baseName': 'chess-engine'
        attributes 'version': '1.0'
    }
}

shadowJar {
    manifest {
        attributes 'Main-Class': application.mainClass
    }
    configurations = [project.configurations.runtimeClasspath]
}

jpro {
    port = 8080
}
```

### settings.gradle (from repository root)
```groovy
/*
 * This file was generated by the Gradle 'init' task.
 *
 * The settings file is used to specify which projects to include in your build.
 * For more detailed information on multi-project builds, please refer to https://docs.gradle.org/8.6/userguide/multi_project_builds.html in the Gradle documentation.
 */
buildscript {
    repositories {
        gradlePluginPortal()

        maven {
            url "https://sandec.jfrog.io/artifactory/repo"
        }
    }

    dependencies {
        classpath "one.jpro:jpro-gradle-plugin:2023.3.1"
    }
}

plugins {
    // Apply the foojay-resolver plugin to allow automatic download of JDKs
    id 'org.gradle.toolchains.foojay-resolver-convention' version '0.7.0'
}

rootProject.name = 'chess'
include('engine')

```


```bash
./gradlew build
./gradlew jproRelease
```

## Step 3: Modify Dockerfile
The previous `jproRelease` task will generate a `.zip` file, located in `engine/build/distributions`, which will contain the whole folder we'll be deploying.
You'll have to unzip it in your repository, preferably in the root.

Once extracted, we'll need to modify the Dockerfile that the folder provides us.\
It should be something like this: \

Note: the only thing you should change is the ``FROM``, which has to be `openjdk:21-jdk-slim`
```Dockerfile
FROM openjdk:21-jdk-slim
RUN apt-get update
RUN apt-get -y install xorg gtk2-engines libasound2 libgtk2.0-0
# Added in docker-compose.yml 
# ADD . jproserver/
CMD (cd jproserver/; ./bin/restart.sh)
```

## Step 4: Run the Docker Container

Run the Docker container using the image you just built.

```bash
docker compose up
```

## Step 5: Access and use the Application

Once the container is running, you can access the application by navigating to `http://localhost:8080` in your web browser.

## Step 6: Deployment

When your image is already built, you'll be able to run the jPro application without problems. \
For you to deploy it, you'll have to use a deployment service. In this tutorial, we'll be using [Render](https://render.com).

Once you create an account (preferably with [GitHub](https://github.com) ), you'll have to create a new `Web Service` in the ``Dashboard``.

You'll have to choose your Chess Repository, provide Render access to it, and choose the ``engine-jpro`` directory you extracted in your repository.

Select the Dockerfile in that directory and deploy the application.

### PD 
If the deployment does not work because of file execution permissions, you may need to change the Dockerfile.\
Down below is the one that **_MUST_** work:


```Dockerfile
FROM openjdk:21-jdk-slim

# Update package list and install necessary packages
RUN apt-get update && apt-get -y install \
    xorg \
    gtk2-engines \
    libasound2 \
    libgtk2.0-0 \
    libnss3 \
    libx11-xcb1 \
    libxcomposite1 \
    libxcursor1 \
    libxdamage1 \
    libxi6 \
    libxtst6 \
    libxrandr2 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set the working directory in the container
WORKDIR /app
# Set the JAVA_HOME environment variable
ENV JAVA_HOME /usr/local/openjdk-21

# Set the JPRO_HOME environment variable
ENV JPRO_HOME /app/jproserver

# Set the JPRO_PORT environment variable
ENV JPRO_PORT 8080

EXPOSE 8080


# Copy the project files into the container
COPY ./ /app

# Ensure the restart script is executable and exists
RUN chmod +x bin/*.sh

# Run the restart script
CMD ["bin/restart.sh"]
```


## Conclusion

By following these steps, you should be able to deploy the Chess project successfully.
